#!/bin/bash

set -ex

FILE=$1

KVER=${1/linux-}
KVER=${KVER//.tar.xz}

# sanity check ifnux-4.4.3-minnow-drone+.tar.xz file has that module directory
have_modules=$(tar -tf $FILE usr/lib/modules/$KVER | head -n 1)
if [ -z "$have_modules" ]; then
    echo "wrong file name or kernel doesn't have any modules directory" >&2
    exit 1
fi

# remove previous modules
rm -rf /usr/lib/modules/$KVER

# install kernel and modules on /usr/lib
tar -C / -m -xf $FILE

# copy kernel to boot partition, install bootloader entry and possibly
# generate an initrd

if [ ! -z "$(which kernel-install)" ]; then
    kernel-install add $KVER /usr/lib/custom-kernel/vmlinuz
else
    echo "Just going to install the kernel, bootloader config is on you"
    cp /usr/lib/custom-kernel/vmlinuz /boot/${2:-vmlinuz-test}
fi
